<html>
    <head>
        <!-- libs -->
        <script src="../js/underscore.js"></script> 
        <!-- main lib -->
        <script src="../js/orange2.js"></script> 
        <!-- classes -->
        <script src="../js/class.layer.js"></script> 
        <script src="../js/class.image_manager.js"></script> 
        <script src="../js/class.image_map.js"></script> 
        <script src="../js/class.sprite.js"></script> 
        <script src="../js/class.animation.js"></script> 
        
</head>

    <body>
        <canvas id="main" width="256" height="224" style="background-color: black"></canvas>
        <input type="text" id="pos" />
    </body>
    
<script>
    // basura global
    var nave, 
        aEnemy = [],
        x=0, 
        y=0, 
        dx=0, 
        dy=0;
        
    var global = {};
    global.enemyDx = 1;
    global.skipFrameCounter = 0; // este contador es para evitar que se ejecuten los eventos de los spr de las filas por debajo.
    
        
    // Primero que nada: inicializar la libreria
    Orange.init(document.getElementById("main"));
    
    // agrego las imagenes que quiero utilizar.
    Orange.getImageManager().addImage(["img/bala_enemy.png", 
        "img/enemy1.png", 
        "img/enemy2.png", 
        "img/enemy3.png", 
        "img/ufo.png", 
        "img/nave.png", 
        "img/borrar/screenShotSI.png", 
        "img/defensa.png" ]);
    
    // Inicio la precarga, cuando finalize llama al callback.
    // mas adelante tengo que hacerlo mejor, con un objeto que tenga sucess, error, progress, etc.
    Orange.getImageManager().preload(function(){

        
        // ImageMaps
        var naveImageMap = new Orange.ImageMap(Orange.getImageManager().get("nave"), 16,8);
        var defensaImageMap = new Orange.ImageMap(Orange.getImageManager().get("defensa"), 22,16);
        var enemy3ImageMap = new Orange.ImageMap(Orange.getImageManager().get("enemy3"), 10,8);
        var enemy2ImageMap = new Orange.ImageMap(Orange.getImageManager().get("enemy2"), 13,8);
        var enemy1ImageMap = new Orange.ImageMap(Orange.getImageManager().get("enemy1"), 14,8);
        
        // Animations
        var naveAnimation = new Orange.Animation(naveImageMap, {
            statusConfig : [ 
                { loopMode : "L"},
                { loopMode : "L"}
            ],
            speed : 1
        });
        
        var enemy3Animation = new Orange.Animation(enemy3ImageMap, {
            statusConfig : [ 
                { loopMode : "L"},
                { loopMode : "L"}
            ],
            speed : 1
        });

        
        var enemy2Animation = new Orange.Animation(enemy2ImageMap, {
            statusConfig : [ 
                { loopMode : "L"},
                { loopMode : "L"}
            ],
            speed : 1
        });

        var enemy1Animation = new Orange.Animation(enemy1ImageMap, {
            statusConfig : [ 
                { loopMode : "L"},
                { loopMode : "L"}
            ],
            speed : 1
        });
        
        
        // Sprites
        nave = new Orange.Sprite({
            src : naveAnimation,
            speed : 1
        });
        
        var defensa1 = new Orange.Sprite({
            src : defensaImageMap
        });

        var defensa2 = new Orange.Sprite({
            src : defensaImageMap
        });

        var defensa3 = new Orange.Sprite({
            src : defensaImageMap
        });

        var defensa4 = new Orange.Sprite({
            src : defensaImageMap
        });
        
        
        // Layers
        var l = new Orange.Layer();
        Orange.addLayer(l);
        l.setBackground(Orange.getImageManager().get("screenShotSI"))
        l.addSprite(nave); 
        l.addSprite(defensa1);
        l.addSprite(defensa2);
        l.addSprite(defensa3);
        l.addSprite(defensa4);

        
        // creo una bocha de sprites, y los posiciono en cualquier parte

        for(var i=0; i<11; i++) {
            var enemy3 = new Orange.Sprite({
                src : enemy3Animation
            });
            l.addSprite(enemy3); 
            aEnemy.push(enemy3);

            enemy3.on("enterFrame", function(eventData, s) { 
                if( ((s.getX() <= 0) || (s.getX() >= 240)) && global.skipFrameCounter <= 0) {
                    global.enemyDx = -global.enemyDx;
                    global.skipFrameCounter = 10; // esto para evitar q las naves por debajo de esta fila me cambien el estado.
                }
            });
            
            enemy3.setX(i*16 + 49).setY(40);
        }

        for(var j=0; j<2; j++) {
            for(var i=0; i<11; i++) {
                var enemy2 = new Orange.Sprite({
                    src : enemy2Animation
                });
                l.addSprite(enemy2); 
                aEnemy.push(enemy2);

                enemy2.on("enterFrame", function(eventData, s) { 
                    if( ((s.getX() <= 0) || (s.getX() >= 240)) && global.skipFrameCounter <= 0) {
                        global.enemyDx = -global.enemyDx;
                        global.skipFrameCounter = 10; // esto para evitar q las naves por debajo de esta fila me cambien el estado.
                    }
                });
                
                enemy2.setX(i*16 + 49).setY(56 + j*16);
            }
        }


        for(var j=0; j<2; j++) {
            for(var i=0; i<11; i++) {
                var enemy1 = new Orange.Sprite({
                    src : enemy1Animation
                });
                l.addSprite(enemy1); 
                aEnemy.push(enemy1);
                
                // Bindings enemys 
                // SIEMPRE es necesario agregar primero el sprite antes de asignarle algun evento
                enemy1.on("enterFrame", function(eventData, s) { 
                    if( ((s.getX() <= 0) || (s.getX() >= 240)) && global.skipFrameCounter <= 0) {
                        global.enemyDx = -global.enemyDx;
                        global.skipFrameCounter = 2; // esto para evitar q las naves por debajo de esta fila me cambien el estado.
                    }
                });

                
                
                // posicionamiento enemigos
                enemy1.setX(i*16 + 49).setY(88 + j*16);
            }
        }
        
        
        nave.setX(110).setY(192);
        defensa1.setX(48).setY(168);
        defensa2.setX(93).setY(168);
        defensa3.setX(138).setY(168);
        defensa4.setX(183).setY(168);

        

        // Bind
        nave.on("keydown", function(eventData, s) {
            switch(eventData.e.keyCode) {
                case 39 :   dx = s.getSpeed();
                            break;
                case 37 :   dx = -s.getSpeed();
                            break;
            }
            
        });

        nave.on("keyup", function(eventData, s) {
            switch(eventData.e.keyCode) {
                case 39 :   dx = 0;
                            break;
                case 37 :   dx = 0;
                            break;
            }
        });
        
        
        
        // especifico el bucle principal, este se ejecutara 60 veces por segundo.
        Orange.setMainCallback(function() {
            nave.incX(dx);
            
            if (global.skipFrameCounter > 0) global.skipFrameCounter--; 
            
            _.each(aEnemy, function(enemy) {
                document.getElementById("pos").value = global.enemyDx;
                enemy.incX(global.enemyDx);
            });
            
        });
        
        // Inicio la ejecucion del bucle.
        Orange.start();
        //Orange.stop();
    }); // preload
    

    
</script>
</hmtl>
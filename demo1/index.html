<html>
    <head>
        <!-- libs -->
        <script src="../js/underscore.js"></script> 
        <!-- main lib -->
        <script src="../js/orange2.js"></script> 
        <!-- classes -->
        <script src="../js/class.layer.js"></script> 
        <script src="../js/class.image_manager.js"></script> 
        <script src="../js/class.image_map.js"></script> 
        <script src="../js/class.sprite.js"></script> 
        <script src="../js/class.animation.js"></script> 
        
</head>

    <body>
        <canvas id="main" width="256" height="224" style="background-color: black"></canvas>
    </body>
    
<script>
    // basura global
    var nave, 
        x=0, 
        y=0, 
        dx=0, 
        dy=0;

    // Primero que nada: inicializar la libreria
    Orange.init(document.getElementById("main"));
    
    // agrego las imagenes que quiero utilizar.
    Orange.getImageManager().addImage(["img/bala_enemy.png", 
        "img/enemy1.png", 
        "img/enemy2.png", 
        "img/enemy3.png", 
        "img/ufo.png", 
        "img/nave.png", 
        "img/borrar/screenShotSI.png", 
        "img/defensa.png" ]);
    
    // Inicio la precarga, cuando finalize llama al callback.
    // mas adelante tengo que hacerlo mejor, con un objeto que tenga sucess, error, progress, etc.
    Orange.getImageManager().preload(function(){

        
        // ImageMaps
        var naveImageMap = new Orange.ImageMap(Orange.getImageManager().get("nave"), 16,8);
        var defensaImageMap = new Orange.ImageMap(Orange.getImageManager().get("defensa"), 22,16);
        var enemy3ImageMap = new Orange.ImageMap(Orange.getImageManager().get("enemy3"), 10,8);
        var enemy2ImageMap = new Orange.ImageMap(Orange.getImageManager().get("enemy2"), 13,8);
        
        // Animations
        var naveAnimation = new Orange.Animation(naveImageMap, {
            statusConfig : [ 
                { loopMode : "L"},
                { loopMode : "L"}
            ],
            speed : 1
        });
        
        var enemy3Animation = new Orange.Animation(enemy3ImageMap, {
            statusConfig : [ 
                { loopMode : "L"},
                { loopMode : "L"}
            ],
            speed : 1
        });

        
        var enemy2Animation = new Orange.Animation(enemy2ImageMap, {
            statusConfig : [ 
                { loopMode : "L"},
                { loopMode : "L"}
            ],
            speed : 1
        });
        
        
        // Sprites
        nave = new Orange.Sprite({
            src : naveAnimation,
            speed : 1
        });
        
        var defensa1 = new Orange.Sprite({
            src : defensaImageMap
        });

        var defensa2 = new Orange.Sprite({
            src : defensaImageMap
        });

        var defensa3 = new Orange.Sprite({
            src : defensaImageMap
        });

        var defensa4 = new Orange.Sprite({
            src : defensaImageMap
        });
        
        
        // Layers
        var l = new Orange.Layer();
        Orange.addLayer(l);
        l.setBackground(Orange.getImageManager().get("screenShotSI"))
        l.addSprite(nave); 
        l.addSprite(defensa1);
        l.addSprite(defensa2);
        l.addSprite(defensa3);
        l.addSprite(defensa4);

        
        // creo una bocha de sprites, y los posiciono en cualquier parte

        for(var i=0; i<11; i++) {
            var enemy3 = new Orange.Sprite({
                src : enemy3Animation
            });
            l.addSprite(enemy3); 
            enemy3.setX(i*16 + 49).setY(40);
        }

        for(var j=0; j<2; j++) {
            for(var i=0; i<11; i++) {
                var enemy2 = new Orange.Sprite({
                    src : enemy2Animation
                });
                l.addSprite(enemy2); 
                enemy2.setX(i*16 + 49).setY(56 + j*16);
            }
        }
        
        
        nave.setX(110).setY(192);
        defensa1.setX(48).setY(168);
        defensa2.setX(93).setY(168);
        defensa3.setX(138).setY(168);
        defensa4.setX(183).setY(168);

        

        // Bind
        nave.on("keydown", function(eventData, s) {
            switch(eventData.e.keyCode) {
                case 39 :   dx = s.getSpeed();
                            break;
                case 37 :   dx = -s.getSpeed();
                            break;
            }
            
        });

        nave.on("keyup", function(eventData, s) {
            switch(eventData.e.keyCode) {
                case 39 :   dx = 0;
                            break;
                case 37 :   dx = 0;
                            break;
            }
        });
        
// los eventos se tienen q asignar LUEGO de agregar los sprites al layer...
/*
        pacman_s.on("collision", function(eventName, context, aCollision) {
            _.each(aCollision, function(sprite) {
                // segun para donde este moviendose MI sprite (context), entonces voy a empujar para ese lado.
                switch(context.getDir()) {
                    case Orange.Sprite.MOVE_DOWN : sprite.incY(-2);
                                                   break
                                                   
                    case Orange.Sprite.MOVE_DOWN_LEFT : sprite.incY(-2);
                                                        sprite.incX(-2);
                                                        break
                                                        
                    case Orange.Sprite.MOVE_UP : sprite.incY(2);
                                                 break
                                                 
                    case Orange.Sprite.MOVE_UP_LEFT : sprite.incY(2);
                                                      sprite.incX(-2);
                                                      break
                                                      
                    case Orange.Sprite.MOVE_LEFT :  sprite.incX(-2);
                                                    break
                                                    
                    case Orange.Sprite.MOVE_RIGHT : sprite.incX(2);
                                                    break
                                                    
                    case Orange.Sprite.MOVE_DOWN_RIGHT : sprite.incX(2);
                                                         sprite.incY(-2);
                                                         break
                                                         
                    case Orange.Sprite.MOVE_UP_RIGHT :  sprite.incX(2);
                                                        sprite.incY(2);
                                                        break
                }
            })
        }); 
*/        
        
        // otro layer mas, los layers se iran dibujando en el orden en que se van agregando
        //var m = new Orange.Layer();
        //m.setBackground(Orange.getImageManager().get("overfg"));
        //Orange.addLayer(m);

        
        
        // especifico el bucle principal, este se ejecutara 60 veces por segundo.
        Orange.setMainCallback(function() {
            nave.incX(dx);
        });
        
        // Inicio la ejecucion del bucle.
        Orange.start();
        //Orange.stop();
    }); // preload
    

    
</script>
</hmtl>
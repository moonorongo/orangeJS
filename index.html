<html>
    <head>
        <!-- libs -->
        <script src="js/underscore.js"></script> 
        <!-- main lib -->
        <script src="js/orange2.js"></script> 
        <!-- classes -->
        <script src="js/class.layer.js"></script> 
        <script src="js/class.image_manager.js"></script> 
        <script src="js/class.image_map.js"></script> 
        <script src="js/class.sprite.js"></script> 
        
</head>

    <body>

    </body>
    
<script>
    // basura global
    var pacman_im, pacman_im2, pacman_s, pacman_t, x=0, y=0, dx=0, dy=0, l;

    // Primero que nada: inicializar la libreria
    Orange.init();
    
    // agrego las imagenes que quiero precargar.
    Orange.getImageManager().addImage(["img/bg.png","img/overfg.png", "img/pacman2.png", "img/floor.png", "img/gargamel.png"]);
    
    // Inicio la precarga, cuando finalize llama al callback.
    // mas adelante tengo que hacerlo mejor, con un objeto que tenga sucess, error, progress, etc.
    Orange.getImageManager().preload(function(){

        // con la imagen de gargamel, armo un imageMap.
        // Un imagemap es un TILE, que va a tiene metodos para obtener el tile deseado.
        pacman_im = new Orange.ImageMap(Orange.getImageManager().get("gargamel"), 70,70);
        pacman_im2 = new Orange.ImageMap(Orange.getImageManager().get("pacman2"), 16,16);
        
        // inicializo un sprite, le paso el imageMap recien creado, le especifico un punto de pivot (que sera utilizado para varias cosas)
        // y una velocidad
        pacman_s = new Orange.Sprite({
            src : pacman_im,
            pivotX : 36,
            pivotY : 60,
            speed : 1
        });

        pacman_t = new Orange.Sprite({
            src : pacman_im2,
            speed : 2
        });
        
        
        // creo un layer
        l = new Orange.Layer();
        // lo agrego a la libreria
        Orange.addLayer(l);
        // le especifico un fondo y una imagen delimitante (boundary)
        // si tiene sprites, tiene q tener un boundary si o si... ARREGLAR ESTO
        l.setBackground(Orange.getImageManager().get("bg.png"));
        l.setBoundary(Orange.getImageManager().get("floor.png"))
        
        // le agrego el sprite recien creado
        // estaria bueno que tome varios... (pacman, p2,p3...)
        l.addSprite(pacman_s); 
        l.addSprite(pacman_t); 

        // posicion el sprite en 0,120
        pacman_t.setX(0).setY(0);
        pacman_s.setX(100).setY(50);

/*
        pacman_s.on("mousedown", function(eventData) {
            //console.log(extra);
            if(eventData.extra.clicked) console.log("clicked");
        });
*/
        
        // si pulso una tecla, que haga algo, en el callback especifico que quiero
        // el callback recibe un objeto eventData, con varios valores, y una referencia al objeto
        pacman_t.on("keydown", function(eventData, s) {
            switch(eventData.e.keyCode) {
                case 38 :   dy = -s.getSpeed();
                            break;
                case 40 :   dy = s.getSpeed();
                            break;
                case 39 :   dx = s.getSpeed();
                            break;
                case 37 :   dx = -s.getSpeed();
                            break;
            }
            
        });

        pacman_t.on("keyup", function(eventData, s) {
            switch(eventData.e.keyCode) {
                case 38 :   dy = 0;
                            break;
                case 40 :   dy = 0;
                            break;
                case 39 :   dx = 0;
                            break;
                case 37 :   dx = 0;
                            break;
            }
        });
        
// los eventos se tienen q asignar LUEGO de agregar los sprites al layer...

        pacman_t.on("collision", function(eventName, context, aCollision) {
            _.each(aCollision, function(sprite) {
                switch(context.getDir()) {
                    case Orange.Sprite.MOVE_DOWN :    sprite.incY(-2);
                                                      break
                    case Orange.Sprite.MOVE_UP :    sprite.incY(2);
                                                    break
                    case Orange.Sprite.MOVE_LEFT :    sprite.incX(-2);
                                                    break
                    case Orange.Sprite.MOVE_RIGHT :    sprite.incX(2);
                                                    break
                }
            })
        }); 
        
        
        // otro layer mas, los layers se iran dibujando en el orden en que se van agregando
        var m = new Orange.Layer();
        m.setBackground(Orange.getImageManager().get("overfg"));
        Orange.addLayer(m);

        // especifico el bucle principal, este se ejecutara 60 veces por segundo.
        Orange.setMainCallback(function() {
            
            
            pacman_t.incX(dx).incY(dy);
            //pacman_s.incY(1);

        });
        
        // Inicio la ejecucion del bucle.
        Orange.start();
        //Orange.stop();
    }); // preload
    

    
</script>
</hmtl>